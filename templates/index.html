<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片处理工具</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/mobile.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/static/js/main.js"></script>
</head>
<body>
    <div class="container-fluid">
        <!-- 进度显示 -->
        <div id="progress-overlay" class="progress-overlay" style="display: none;">
            <div class="progress-content">
                <h2 id="progress-title">处理进度</h2>
                <div class="progress-info">
                    <p>总文件数: <span id="total-files">0</span></p>
                    <p>已处理: <span id="processed-files">0</span></p>
                    <p id="current-file" style="display: none;">当前处理: <span id="current-file-path" class="current-file-path"></span></p>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span id="progress-percentage" class="progress-percentage">0.0%</span>
                        </div>
                    </div>
                </div>
                <div id="statistics" style="display: none;">
                    <h3>处理统计</h3>
                    <p>总耗时: <span id="total-time">0</span> 秒</p>
                    <p>原始大小: <span id="original-size">0</span> MB</p>
                    <p>处理后大小: <span id="final-size">0</span> MB</p>
                    <p>压缩率: <span id="compression-rate">0</span>%</p>
                    <p id="ignored-files-section" style="display: none;">被忽略文件: <span id="ignored-files-count">0</span> 个（小于<span id="ignored-files-threshold">0 KB</span>）</p>
                </div>
                
                <!-- 失败文件列表 -->
                <div id="failed-files-section">
                    <h6 id="failed-files-title">失败的文件（共<span id="failed-files-count">0</span>个）</h6>
                    <div id="failed-files" class="pre-scrollable">
                        <!-- 失败文件列表将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 跳过文件列表 -->
                <div id="skipped-files-section">
                    <h6 id="skipped-files-title">跳过的文件（共<span id="skipped-files-count">0</span>个）</h6>
                    <div id="skipped-files" class="pre-scrollable">
                        <!-- 跳过文件列表将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="progress-actions">
                    <button id="stop-progress" class="btn btn-danger btn-margin-right" style="display: none;">停止处理</button>
                    <button id="close-progress" class="btn btn-primary" style="display: none;">关闭</button>
                </div>
            </div>
        </div>

        <!-- 主容器 -->
        <div class="main-container">
            <!-- 文件选择区域 -->
            <div class="row">
                <!-- 左侧文件列表 -->
                <div class="col-md-8">
                    <div class="file-select-container">
                        <div class="path-bar">
                            <span id="current-path">/data</span>
                        </div>
                        <div class="file-actions">
                            <button id="back-btn" class="btn btn-secondary">返回上级</button>
                            <button id="select-all-btn" class="btn btn-secondary">全选</button>
                            <button id="deselect-all-btn" class="btn btn-secondary">取消全选</button>
                            <button id="search-btn" class="btn btn-success">搜索文件</button>
                            <button id="count-formats-btn" class="btn btn-info">统计文件格式</button>
                            <button id="fix-extensions-btn" class="btn btn-warning">修复文件后缀</button>
                            <button id="clean-empty-folders-btn" class="btn btn-danger">清理空文件夹</button>
                            <button id="compress-btn" class="btn btn-primary" disabled>图片压缩</button>
                            <button id="convert-btn" class="btn btn-primary" disabled>图片转换</button>
                            <button id="upload-btn" class="btn btn-primary">上传图片处理</button>
                        </div>
                        <div id="file-list" class="file-list">
                            <!-- 文件列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
                <!-- 右侧已选择文件列表 -->
                <div class="col-md-4">
                    <div class="selected-files-container">
                        <h3>已选择文件（夹）</h3>
                        <div id="selected-files-list" class="selected-files-list">
                            <p class="no-selection">未选择任何文件</p>
                        </div>
                        
                        <!-- 版本号显示 -->
                        <div class="version-info">
                            版本号: <a id="app-version" href="https://github.com/ChenXu178/image-processor" target="_blank" rel="noopener noreferrer">加载中...</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片压缩模态框 -->
        <div class="modal fade" id="compress-modal" tabindex="-1" role="dialog" aria-labelledby="compress-modal-title" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="compress-modal-title">图片压缩配置</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="compress-container">
                            <div class="card">
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="compression-quality">压缩率：<span id="quality-value">80</span>%</label>
                                        <input type="range" class="form-control-range" id="compression-quality" min="1" max="100" value="80">
                                    </div>
                                    <div class="form-group">
                                        <label for="min-file-size">最小文件大小（KB）</label>
                                        <input type="text" class="form-control" id="min-file-size" value="2048" placeholder="支持公式输入，如：1024*4">
                                        <small class="form-text text-muted">小于此大小的文件将被忽略，支持公式输入（如：1024*4）</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="thread-count">使用线程数：<span id="thread-value">4</span></label>
                                        <input type="range" class="form-control-range" id="thread-count" min="1" max="8" value="4">
                                    </div>
                                    <button id="start-compress-btn" class="btn btn-primary">开始压缩</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片转换模态框 -->
    <div class="modal fade" id="convert-modal" tabindex="-1" role="dialog" aria-labelledby="convert-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="convert-modal-title">图片转换配置</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="convert-container">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="target-format">目标格式</label>
                                    <select class="form-control" id="target-format">
                                        <!-- 动态生成支持的格式选项 -->
                                    </select>
                                </div>
                                <div class="form-group form-check" id="skip-pdf-container">
                                    <input type="checkbox" class="form-check-input" id="skip-pdf-checkbox" checked>
                                    <label class="form-check-label" for="skip-pdf-checkbox">跳过PDF文件</label>
                                </div>
                                <div class="form-group">
                                    <label for="convert-quality">压缩率：<span id="convert-quality-value">99</span>%</label>
                                    <input type="range" class="form-control-range" id="convert-quality" min="1" max="100" value="99">
                                </div>
                                <div class="form-group">
                                    <label for="convert-thread-count">使用线程数：<span id="convert-thread-value">4</span></label>
                                    <input type="range" class="form-control-range" id="convert-thread-count" min="1" max="8" value="4">
                                </div>
                                <button id="start-convert-btn" class="btn btn-primary">开始转换</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计结果模态框 -->
    <div class="modal fade" id="statistics-modal" tabindex="-1" role="dialog" aria-labelledby="statistics-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statistics-modal-title">文件格式统计</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="statistics-result" class="statistics-result">
                        <!-- 统计结果将通过JS动态生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="modal fade" id="image-preview-modal" tabindex="-1" role="dialog" aria-labelledby="image-preview-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="image-preview-title">图片预览</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="preview-image" src="" class="img-fluid" alt="Preview">
                    <div id="image-info" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 鼠标悬停预览 -->
    <div id="hover-preview" class="hover-preview" style="display: none;">
        <img id="hover-preview-image" src="">
    </div>

    <!-- 搜索模态框 -->
    <div class="modal fade" id="search-modal" tabindex="-1" role="dialog" aria-labelledby="search-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="search-modal-title">搜索文件</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="search-form" onsubmit="return false;">
                        <div class="form-group">
                            <label for="search-pattern">关键字 (支持正则表达式)</label>
                            <input type="search" class="form-control" id="search-pattern" placeholder="例如: .*\.jpg$" enterkeyhint="search" autocomplete="off">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="search-regex">
                            <label class="form-check-label" for="search-regex">使用正则表达式</label>
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="search-case-sensitive">
                            <label class="form-check-label" for="search-case-sensitive">区分大小写</label>
                        </div>
                        <button type="button" id="start-search-btn" class="btn btn-primary">开始搜索</button>
                    </form>
                    <div id="search-results" class="mt-3">
                        <!-- 搜索结果将通过JS动态生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修复结果模态框 -->
    <div class="modal fade" id="fix-result-modal" tabindex="-1" role="dialog" aria-labelledby="fix-result-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fix-result-modal-title">修复文件后缀结果</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="fix-result-summary" class="mb-3"></div>
                    <div id="fix-skipped-files-section" class="mb-4">
                        <h6>跳过的文件（共<span id="skipped-count">0</span>个）</h6>
                        <div id="fix-skipped-files-list" class="pre-scrollable"></div>
                    </div>
                    <div id="fix-failed-files-section" class="mb-4">
                        <h6>失败的文件（共<span id="failed-count">0</span>个）</h6>
                        <div id="fix-failed-files-list" class="pre-scrollable"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用提示模态框 -->
    <div class="modal fade" id="alert-modal" tabindex="-1" role="dialog" aria-labelledby="alert-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alert-modal-title">提示</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="alert-modal-message"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通用确认模态框 -->
    <div class="modal fade" id="confirm-modal" tabindex="-1" role="dialog" aria-labelledby="confirm-modal-title" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirm-modal-title">确认</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="confirm-modal-message"></p>
                </div>
                <div class="modal-footer confirm-btns">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-modal-ok">确定</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast模态框 -->
    <div class="modal fade" id="toast-modal" tabindex="-1" role="dialog" aria-labelledby="toast-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="toast-modal-title">提示</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="toast-modal-message"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件上传选择模态框 -->
    <div class="modal fade" id="upload-select-modal" tabindex="-1" role="dialog" aria-labelledby="upload-select-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="upload-select-modal-title">选择要上传的文件</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="file-input">选择图片或PDF文件（支持多选）</label>
                        <input type="file" class="form-control-file" id="file-input" multiple accept=".jpg,.jpeg,.png,.webp,.avif,.heic,.bmp,.gif,.tiff,.pdf">
                    </div>
                    <div id="selected-upload-files" class="selected-upload-files mt-3">
                        <h6>已选择文件（<span id="selected-count">0</span>个）</h6>
                        <ul id="upload-files-list" class="list-group pre-scrollable" style="max-height: 200px;"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-upload-btn" disabled>确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传图片处理配置模态框 -->
    <div class="modal fade" id="upload-process-modal" tabindex="-1" role="dialog" aria-labelledby="upload-process-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="upload-process-modal-title">图片处理配置</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="upload-files-section mb-3">
                        <h6>已选择的文件（<span id="process-file-count">0</span>个）</h6>
                        <div id="process-files-list" class="pre-scrollable" style="max-height: 200px; background-color: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
                    </div>
                    <div class="upload-settings-section">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label>处理方式</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="process-type" id="process-compress" value="compress" checked>
                                            <label class="form-check-label" for="process-compress">图片压缩（PDF不支持压缩）</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="process-type" id="process-convert" value="convert">
                                            <label class="form-check-label" for="process-convert">图片转换</label>
                                        </div>
                                    </div>
                                </div>
                                <div id="convert-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="upload-target-format">目标格式</label>
                                        <select class="form-control" id="upload-target-format">
                                        </select>
                                    </div>
                                    <div class="form-group form-check" id="upload-skip-pdf-container">
                                        <input type="checkbox" class="form-check-input" id="upload-skip-pdf" checked>
                                        <label class="form-check-label" for="upload-skip-pdf">跳过PDF文件</label>
                                    </div>
                                </div>
                                <div class="form-group" id="upload-compression-quality-container">
                                    <label for="upload-compression-quality">压缩率：<span id="upload-quality-value">80</span>%</label>
                                    <input type="range" class="form-control-range" id="upload-compression-quality" min="1" max="100" value="80" data-compress="80" data-convert="99">
                                </div>
                                <div class="form-group" id="upload-pdf-password-container" style="display: none;">
                                    <label for="upload-pdf-password">PDF密码（留空不加密）</label>
                                    <input type="text" class="form-control" id="upload-pdf-password" placeholder="输入PDF打开密码">
                                </div>
                                <div class="form-group">
                                    <label for="upload-thread-count">使用线程数：<span id="upload-thread-value">4</span></label>
                                    <input type="range" class="form-control-range" id="upload-thread-count" min="1" max="8" value="4">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="start-upload-process-btn">开始处理</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传和处理进度模态框 -->
    <div class="modal fade" id="upload-progress-modal" tabindex="-1" role="dialog" aria-labelledby="upload-progress-modal-title" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="upload-progress-modal-title">上传和处理进度</h5>
                </div>
                <div class="modal-body">
                    <div class="upload-progress-section mb-3">
                        <h6>上传进度</h6>
                        <div class="progress">
                            <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mt-1">已上传: <span id="uploaded-count">0</span>/<span id="upload-total-count">0</span> 个文件</p>
                    </div>
                    <div class="process-progress-section">
                        <h6>处理进度</h6>
                        <div class="progress">
                            <div id="process-progress-bar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mt-1">已处理: <span id="processed-count">0</span>/<span id="process-total-count">0</span> 个文件</p>
                        <p id="upload-current-file" style="display: none;">当前处理: <span id="upload-current-file-path" class="current-file-path"></span></p>
                    </div>
                    <div id="upload-failed-files-section" style="display: none;" class="mt-3">
                        <h6>失败的文件（共<span id="upload-failed-count">0</span>个）</h6>
                        <div id="upload-failed-files" class="pre-scrollable" style="max-height: 100px; background-color: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
                    </div>
                </div>
                <div class="modal-footer" id="upload-progress-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="close-upload-progress" style="display: none;">关闭</button>
                    <button type="button" class="btn btn-primary" id="download-result-btn" style="display: none;">下载</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p id="loading-text">正在处理，请稍候...</p>
        </div>
    </div>
    
    
</body>
</html>